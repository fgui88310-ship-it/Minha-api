import express from 'express';
import { fetchAmazonSearchHTML } from '../../services/amazonService.js';
import { parseAmazonProducts } from '../../【 UTILS 】/parseAmazonProduct.js';

const router = express.Router();

router.get('/', async (req, res, next) => {
  const { query, limit = 5 } = req.query;
  if (!query) return res.status(400).json({ error: 'Passe ?query= para buscar produtos' });

  try {
    const html = await fetchAmazonSearchHTML(query);
    const produtos = parseAmazonProducts(html, limit);

    if (produtos.length === 0) return res.status(404).json({ error: 'Nenhum produto encontrado' });

    res.json(produtos);
  } catch (err) {
    next(err);
  }
});

export default router;