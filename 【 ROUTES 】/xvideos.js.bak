import express from 'express';
import axios from "axios";
import * as cheerio from "cheerio";

const router = express.Router();

// Função para buscar vídeos
async function fetchXvideos(query, limit = 10) {
  const searchUrl = `https://www.xvideos.com/?k=${encodeURIComponent(query)}`;
  const { data } = await axios.get(searchUrl, {
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    },
    timeout: 5000,
  });

  const $ = cheerio.load(data);
  const videos = [];

  $("#content .mozaique .thumb-block").each((i, video) => {
    if (videos.length >= limit) return false; // Limita quantidade
    const el = $(video);
    const titleEl = el.find("p a").eq(0);

    const videoData = {
      title: titleEl.text().trim(),
      url: "https://www.xvideos.com" + titleEl.attr("href"),
      duration: el.find(".duration").text().trim(),
      thumb: el.find(".thumb img").attr("data-src")?.replace("THUMBNUM", "5") || null
    };

    // Validação simples
    if (videoData.title && videoData.url) videos.push(videoData);
  });

  return videos;
}

// Endpoint GET /api/xvideos?query=...&limit=...
router.get('/', async (req, res) => {
  const { query, limit = 10 } = req.query;
  if (!query) return res.status(400).json({ error: 'Passe ?query= para buscar vídeos' });

  try {
    const results = await fetchXvideos(query, Number(limit));
    if (results.length === 0) return res.status(404).json({ error: 'Nenhum vídeo encontrado' });
    res.json(results);
  } catch (err) {
    next(err);
  }
});

export default router;