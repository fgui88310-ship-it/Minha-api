// api/endpoints/nasa.js
import express from 'express';
import fetch from 'node-fetch'; // ou axios, se preferir
import translate from 'translate-google';

const router = express.Router();

/**
 * Endpoint: /api/nasa?date=YYYY-MM-DD
 * Retorna a imagem APOD da NASA e a explicação traduzida.
 */
router.get('/', async (req, res, next) => {
  const { date } = req.query;

  if (!date) {
    return res.status(400).json({ error: 'Passe a data no formato ?date=YYYY-MM-DD' });
  }

  try {
    const apiKey = '3F7cEz5PlCsWeDTUcvDTS3q9zIjX5fijHPVJHU4F';
    const url = `https://api.nasa.gov/planetary/apod?date=${date}&api_key=${apiKey}`;

    const response = await fetch(url);
    console.log(response) 
    const apodResult = await response.json();

    if (!apodResult || !apodResult.title) {
      return res.status(404).json({ error: 'Não foi possível obter a imagem da NASA. Tente outra data.' });
    }

    // Traduz a explicação
    const translatedExplanation = await translate(
      apodResult.explanation.replace(/A new APOD RSS feed is available here, or from the link line below\./g, '').trim(),
      { to: 'pt' }
    );

    res.json({
      date: date,
      title: apodResult.title,
      copyright: apodResult.copyright || 'Sem resultado',
      explanation: translatedExplanation,
      imageUrl: apodResult.hdurl
    });

  } catch (err) {
    next(err);
  }
});

export default router;
