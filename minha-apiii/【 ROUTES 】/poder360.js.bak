import express from 'express';
import axios from 'axios';
import xml2js from 'xml2js';
import * as cheerio from 'cheerio';

const router = express.Router();

// Função para limpar HTML (remove tags, scripts etc.)
function limparHTML(html) {
  if (!html) return '';
  const $ = cheerio.load(html);
  $('script, style, noscript, iframe, svg').remove();
  return $.text().trim();
}

// Busca notícias via RSS do Poder360
async function buscarNoticiasViaFeed(feedUrl = 'https://www.poder360.com.br/feed') {
  try {
    const { data: xml } = await axios.get(feedUrl, {
      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)' },
      timeout: 8000
    });

    const parser = new xml2js.Parser({ explicitArray: false });
    const parsed = await parser.parseStringPromise(xml);

    const items = parsed.rss?.channel?.item || [];
    const lista = Array.isArray(items) ? items : [items];

    return lista.slice(0, 3).map(it => {
      const rawDescricao = it['content:encoded'] || it.description || '';
      const descricaoLimpa = limparHTML(rawDescricao);

      return {
        titulo: it.title || '',
        descricao: descricaoLimpa,
        link: typeof it.link === 'object' ? it.link._ : it.link
      };
    });
  } catch (err) {
    console.error('[PODER360 FEED]', err.message);
    return null;
  }
}

// Endpoint
router.get('/', async (req, res) => {
  try { 
  const noticias = await buscarNoticiasViaFeed();

  if (!noticias || noticias.length === 0) {
    return res.status(404).json({ error: 'Nenhuma notícia encontrada' });
  }

  let msg = `📰 *Notícias recentes do Poder360*\n\n`;
  noticias.forEach((n, i) => {
    msg += `*${i + 1}. ${n.titulo}*\n`;
    if (n.descricao) msg += `📝 ${n.descricao}\n`;
    msg += `🔗 [Leia Mais](${n.link})\n\n`;
  });

  res.json({
    total: noticias.length,
    noticias,
    mensagem_formatada: msg
  });
  } catch (err) { 
  next(err);
  }
});

export default router;